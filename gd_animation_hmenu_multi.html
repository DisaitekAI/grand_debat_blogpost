<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Tendances des réponses au Grand Débat</title>
        <!-- Load D3 from site -->
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    </head>

    <!-- CSS (Styling) -->
    <style type="text/css">
     /* Format X and Y Axis */
     .axis path,
     .axis line {
         fill: none;
         stroke: black;
         shape-rendering: crispEdges;
     }

     .axis text {
         font-family: sans-serif;
         font-size: 11px;
     }

     .dot {
         stroke: none;
     }

     circle {
         opacity: .3;
     }

     h2 {
         text-align: center;
     }

     #navigation_menu {
         float: left;
         /* border: 1px solid blue; */
         margin-top: 10%;
         margin-left: 30px;
         font-size: 15pt;
     }

     #animation {
         /* border: 1px solid red; */
     }

     #animation_steps {
         width: 100%;
         /* margin: auto; */
         font-size: 15px;
         text-align: center;
     }

     #step_00, #step_01, #step_02, #step_03  {
         text-decoration: underline;
     }

     h4 {
         text-decoration: underline;
     }

     #vis-container {
         text-align: center;
     }

     .tooltip {
         position: absolute;
         font-size: 12px;
         width:  auto;
         height: auto;
         pointer-events: none;
         background-color: white;
     }
    </style>
    <!-- End CSS (Styling) -->

    <body>
        <div id="navigation_menu">
            <h4>Question menu</h4>
            <ul>
                <li> Fiscalité et dépenses publiques
                    <ul>
                        <li id="question_01">Information sur les impôts</li>
                        <li id="question_02">Fiscalité juste et efficace</li>
                        <li id="question_03">Impôts à baisser</li>
                        <li id="question_04">Renforcement de la protection sociale</li>
                        <li id="question_05">Payer plus d'impôts</li>
                        <li id="question_06">Autres opinions sur les
                        impôts et dépenses</li>
                    </ul>
                </li>
                <li> Démocratie et citoyenneté
                    <ul>
                        <li id="question_07">Confiance aux représentants</li>
                        <li id="question_08">Renouer le lien avec les élus</li>
                        <li id="question_09">Représenter les sensibilités politiques</li>
                        <li id="question_10">Participation aux élections</li>
                        <li id="question_11">Démocratie participative</li>
                        <li id="question_12">Utilisation de l'argent public</li>
                        <li id="question_13">Rôles des assemblées</li>
                        <li id="question_14">État et religion</li>
                        <li id="question_15">Respect des valeurs de la république</li>
                        <li id="question_16">Renforcer l'engagement citoyen</li>
                        <li id="question_17">Comportements civiques à promouvoir</li>
                        <li id="question_18">Développer les comportements civiques</li>
                        <li id="question_19">Valoriser l'engagement citoyen</li>
                        <li id="question_20">Lutter contre les incivilités</li>
                        <li id="question_21">Pouvoir public contre les incivilités</li>
                        <li id="question_22">Rôle de chacun contre les incivilités</li>
                        <li id="question_23">Discriminations les plus répandues</li>
                        <li id="question_24">Lutter contre les discriminations</li>
                        <li id="question_25">Politique migratoire</li>
                        <li id="question_26">Objectifs d'immigrations</li>
                        <li id="question_27">Solution au défi migratoire</li>
                        <li id="question_28">Modalités d'intégration</li>
                        <li id="question_29">Autres opinions sur la démocratie et la citoyenneté</li>
                    </ul>
                </li>
                <li>
                    Transition écologique
                    <ul>
                        <li id="question_30">Solution environnementales</li>
                        <li id="question_31">Impact du changement climatique</li>
                        <li id="question_32">Action pour protéger l'environnement</li>
                        <li id="question_33">Incitation à changer vos comportements</li>
                        <li id="question_34">Plan financer pour changer les comportements</li>
                        <li id="question_35">Changement de chauffage</li>
                        <li id="question_36">Moyens de transport alternatifs</li>
                        <li id="question_37">Partage des choix au niveau mondial</li>
                        <li id="question_38">Autres opinions sur la transition écologique</li>
                    </ul>
                </li>
                <li>
                    Organisation de l'État et des services publics
                    <ul>
                        <li id="question_39">Opinion sur l'organisation de l'État</li>
                        <li id="question_40">Renforcement des services publics</li>
                        <li id="question_41">Services sur internet</li>
                        <li id="question_42">Évolution des services publics</li>
                        <li id="question_43">Services à faire évoluer</li>
                        <li id="question_44">Règle complexes ou inutiles</li>
                        <li id="question_45">Revoir le fonctionnement de l'administration</li>
                        <li id="question_46">Amélioration des collectivités territoriales</li>
                        <li id="question_47">Administration des formations</li>
                        <li id="question_48">Administration de la scolarisation</li>
                        <li id="question_49">Admnistration de la recherche d'emploi</li>
                        <li id="question_50">Administration de la retraite</li>
                        <li id="question_51">Administration des remboursements santé</li>
                        <li id="question_52">Admnistration des situations de handicap</li>
                        <li id="question_53">Administration des entreprises</li>
                        <li id="question_54">Administration du recrutement</li>
                        <li id="question_55">Administration de la formation du personnel</li>
                        <li id="question_56">Administration de la rémunération du personnel</li>
                        <li id="question_57">Administration de fin d'activité</li>
                        <li id="question_58">Administration du recrutement de personne handicapée</li>
                        <li id="question_59">Autres opinions sur l'organisation de l'État et des services publics</li>
                    </ul>
                </li>
            </ul>
        </div>
        <div id="animation">
            <h2 id="question"></h2>
            <div id="animation_steps">
                <span id="step_00">Commentaires sans traitements</span> →
                <span id="step_01">Cartographie sémantique</span> →
                <span id="step_02">Regrouper les commentaires</span> →
                <span id="step_03">Analyse des groupes de commentaires</span>
            </div>
            <div id="vis-container"></div>
        </div>

        <!-- Begin D3 Javascript -->
        <script type="text/javascript">
         /* d3.csv('./gd_animation_subset.csv', function loadCallback(error, data) { */
         function questionClick(questionId) {
             var activeQuestionColor   = "#438aff";
             var inactiveQuestionColor = "blue";
             questionIdToParams = {
                 "01": {
                     "file": "./gd_animation_fiscalite_11.csv",
                     "text": "Quelles sont toutes les choses qui pourraient être faites<br/>pour améliorer l'information des citoyens sur l'utilisation des impôts ?"
                 },
                 "02": {
                     "file": "./gd_animation_fiscalite_12.csv",
                     "text": "Que faudrait-il faire pour rendre la fiscalité plus juste et efficace ?"
                 },
                 "03": {
                     "file": "./gd_animation_fiscalite_13.csv",
                     "text": "Quels sont selon vous les impôts qu'il faut baisser en priorité ?"
                 },
                 "04": {
                     "file": "./gd_animation_fiscalite_16.csv",
                     "text": "Quels sont les domaines prioritaires où notre protection sociale doit être renforcée ?"
                 },
                 "05": {
                     "file": "./gd_animation_fiscalite_17.csv",
                     "text": "Pour quelle(s) politique(s) ou pour quels domaines d'action publique,<br/>seriez-vous prêts à payer plus d'impôts ?"
                 },
                 "06": {
                     "file": "./gd_animation_fiscalite_18.csv",
                     "text": "Y a-t-il d'autres points sur les impôts et les dépenses<br/>sur lesquels vous souhaiteriez vous exprimer ?"
                 },
                 "07": {
                     "file": "./gd_animation_democratie_11.csv",
                     "text": "En qui faites-vous le plus confiance pour vous faire représenter dans la société et pourquoi ?"
                 },
                 "08": {
                     "file": "./gd_animation_democratie_14.csv",
                     "text": "Que faudrait-il faire pour renouer le lien entre les citoyens et les élus qui les représentent ?"
                 },
                 "09": {
                     "file": "./gd_animation_democratie_17.csv",
                     "text": "Que faudrait-il faire pour mieux représenter les différentes sensibilités politiques ?"
                 },
                 "10": {
                     "file": "./gd_animation_democratie_20.csv",
                     "text": "Que pensez-vous de la participation des citoyens aux élections et comment les inciter à y participer d'avantage ?"
                 },
                 "11": {
                     "file": "./gd_animation_democratie_23.csv",
                     "text": "Que faudrait-il faire aujourd'hui pour mieux associer les citoyens aux grandes orientations et à la décision publique ? Comment mettre en place une démocratie plus participative ?"
                 },
                 "12": {
                     "file": "./gd_animation_democratie_26.csv",
                     "text": "Que faudrait-il faire pour consulter plus directement les citoyens sur l'utilisation de l'argent public, par l'État et les collectivités ?"
                 },
                 "13": {
                     "file": "./gd_animation_democratie_27.csv",
                     "text": "Quel rôle nos assemblées, dont le Sénat et le Conseil économique, social et environnemental, doivent-elles jouer pour représenter nos territoires et la société civile ?"
                 },
                 "14": {
                     "file": "./gd_animation_democratie_30.csv",
                     "text": "Que proposez-vous pour renforcer les principes de la laïcité dans le rapport entre l'Etat et les religions de notre pays ?"
                 },
                 "15": {
                     "file": "./gd_animation_democratie_31.csv",
                     "text": "Comment garantir le respect par tous de la compréhension réciproque et des valeurs intangibles de la République ?"
                 },
                 "16": {
                     "file": "./gd_animation_democratie_32.csv",
                     "text": "Que faudrait-il faire aujourd'hui pour renforcer l'engagement citoyen dans la société ?"
                 },
                 "17": {
                     "file": "./gd_animation_democratie_33.csv",
                     "text": "Quels sont les comportements civiques qu'il faut promouvoir dans notre vie quotidienne ou collective ?"
                 },
                 "18": {
                     "file": "./gd_animation_democratie_34.csv",
                     "text": "Que faudrait-il faire pour favoriser le développement de ces comportements civiques et par quels engagements concrets chacun peut-il y participer ?"
                 },
                 "19": {
                     "file": "./gd_animation_democratie_35.csv",
                     "text": "Que faudrait-il faire pour valoriser l'engagement citoyen dans les parcours de vie, dans les relations avec l'administration et les pouvoirs publics ?"
                 },
                 "20": {
                     "file": "./gd_animation_democratie_36.csv",
                     "text": "Quelles sont les incivilités les plus pénibles dans la vie quotidienne et que faudrait-il faire pour lutter contre ces incivilités ?"
                 },
                 "21": {
                     "file": "./gd_animation_democratie_37.csv",
                     "text": "Que peuvent et doivent faire les pouvoirs publics pour répondre aux incivilités ?"
                 },
                 "22": {
                     "file": "./gd_animation_democratie_38.csv",
                     "text": "Quel pourrait être le rôle de chacun pour faire reculer les incivilités dans la société ?"
                 },
                 "23": {
                     "file": "./gd_animation_democratie_39.csv",
                     "text": "Quelles sont les discriminations les plus répandues dont vous êtes témoin ou victime ?"
                 },
                 "24": {
                     "file": "./gd_animation_democratie_40.csv",
                     "text": "Que faudrait-il faire pour lutter contre ces discriminations et construire une société plus solidaire et plus tolérante ?"
                 },
                 "25": {
                     "file": "./gd_animation_democratie_43.csv",
                     "text": "Que pensez-vous de la situation de l'immigration en France aujourd'hui et de la politique migratoire ? Quelles sont, selon vous, les critères à mettre en place pour définir la politique migratoire ?"
                 },
                 "26": {
                     "file": "./gd_animation_democratie_44.csv",
                     "text": "En matière d'immigration, une fois nos obligations d'asile remplies, souhaitez-vous que nous puissions nous fixer des objectifs annuels définis par le Parlement ?"
                 },
                 "27": {
                     "file": "./gd_animation_democratie_45.csv",
                     "text": "Que proposez-vous afin de répondre à ce défi (l'immigration) qui va durer ?"
                 },
                 "28": {
                     "file": "./gd_animation_democratie_46.csv",
                     "text": "Quelles sont, selon vous, les modalités d'intégration les plus efficaces et les plus justes à mettre en place aujourd'hui dans la société ?"
                 },
                 "29": {
                     "file": "./gd_animation_democratie_47.csv",
                     "text": "Y a-t-il d'autres points sur la démocratie et la citoyenneté sur lesquels vous souhaiteriez vous exprimer ?"
                 },
                 "30": {
                     "file": "./gd_animation_transition_12.csv",
                     "text": "Que faudrait-il faire selon vous pour apporter des réponses au problème que vous considérez le plus important ?"
                 },
                 "31": {
                     "file": "./gd_animation_transition_14.csv",
                     "text": "De quelle manière votre vie quotidienne est-elle touchée par le changement climatique ?"
                 },
                 "32": {
                     "file": "./gd_animation_transition_16.csv",
                     "text": "Si vous pensez pouvoir contribuer á protéger l'environnement, que faites-vous aujourd'hui et/ou que pourriez-vous faire ?"
                 },
                 "33": {
                     "file": "./gd_animation_transition_17.csv",
                     "text": "Qu'est-ce qui pourrait vous inciter à changer vos comportements comme par exemple mieux entretenir et régler votre chauffage, modifier votre manière de conduire ou renoncer à prendre votre véhicule pour de très petites distances ?"
                 },
                 "34": {
                     "file": "./gd_animation_transition_18.csv",
                     "text": "Quelles seraient pour vous les solutions les plus simples et les plus supportables sur un plan financier pour vous inciter à changer vos comportements ?"
                 },
                 "35": {
                     "file": "./gd_animation_transition_20.csv",
                     "text": "Si vous pensez qu'il existe des solutions alternatives à votre mode de chauffage actuel, que faudrait-il pour vous convaincre ou vous aider à changer ?"
                 },
                 "36": {
                     "file": "./gd_animation_transition_22.csv",
                     "text": "Si vous avez la possibilité de recourir à des solutions de mobilité alternatives à la voiture individuelle comme les transports en commun, le covoiturage, l'auto-partage, le transport à la demande, le vélo, etc. que faudrait-il faire pour vous convaincre ou vous aider à les utiliser"
                 },
                 "37": {
                     "file": "./gd_animation_transition_25.csv",
                     "text": "Que pourrait faire la France pour faire partager ses choix en matière d'environnement au niveau européen et international ?"
                 },
                 "38": {
                     "file": "./gd_animation_transition_26.csv",
                     "text": "Y a-t-il d'autres points sur la transition écologique sur lesquels vous souhaiteriez vous exprimer ?"
                 },
                 "38": {
                     "file": "./gd_animation_transition_26.csv",
                     "text": "Y a-t-il d'autres points sur la transition écologique sur lesquels vous souhaiteriez vous exprimer ?"
                 },
                 "39": {
                     "file": "./gd_animation_organisation_11.csv",
                     "text": "Que pensez-vous de l'organisation de l'Etat et des administrations en France ? De quelle manière cette organisation devrait-elle évoluer ?"
                 },
                 "40": {
                     "file": "./gd_animation_organisation_15.csv",
                     "text": "Si vous n'estimez avoir accès aux services publics dont vous avez besoin, quels sont cexu qui manquent sur votre territoire et qu'il est nécessaire de renforcer ?"
                 },
                 "41": {
                     "file": "./gd_animation_organisation_16.csv",
                     "text": "Quels nouveaux services ou quelles démarches souhaitez-vous voir développées sur Internet en priorité ?"
                 },
                 "42": {
                     "file": "./gd_animation_organisation_20.csv",
                     "text": "Quand vous pensez à l'évolution des services publics au cours des dernières années, quels sont ceux qui ont évolué de manière positive ?"
                 },
                 "43": {
                     "file": "./gd_animation_organisation_21.csv",
                     "text": "Quels sont les services publics qui doivent le plus évoluer selon vous ?"
                 },
                 "44": {
                     "file": "./gd_animation_organisation_25.csv",
                     "text": "Pouvez-vous identifier des règles que l'administration vous a déjà demandé d'appliquer et que vous avez jugées inutiles ou trop complexes ?"
                 },
                 "45": {
                     "file": "./gd_animation_organisation_29.csv",
                     "text": "Si vous pensez qu'il faut revoir le fonctionnement et la formation de l'administration, que faut il changer ?"
                 },
                 "46": {
                     "file": "./gd_animation_organisation_30.csv",
                     "text": "Comment l'Etat et les collectivités territoriales peuvent-ils s'améliorer pour mieux répondre aux défis de nos territoires les plus en difficulté ?"
                 },
                 "47": {
                     "file": "./gd_animation_organisation_31.csv",
                     "text": "Si vous avez été amené à chercher une formation, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "48": {
                     "file": "./gd_animation_organisation_32.csv",
                     "text": "Si vous avez été amené à scolariser votre enfant, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "49": {
                     "file": "./gd_animation_organisation_33.csv",
                     "text": "Si vous avez été amené à chercher un emploi, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "50": {
                     "file": "./gd_animation_organisation_34.csv",
                     "text": "Si vous avez été amené à préparer votre retraite, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concerné"
                 },
                 "51": {
                     "file": "./gd_animation_organisation_35.csv",
                     "text": "Si vous avez été amené à demander un remboursement de soins de santé, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "52": {
                     "file": "./gd_animation_organisation_36.csv",
                     "text": "Si vous avez été amené à faire une demande d'aide pour une situation de handicap, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "53": {
                     "file": "./gd_animation_organisation_37.csv",
                     "text": "Si vous avez été amené à créer une entreprise, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "54": {
                     "file": "./gd_animation_organisation_38.csv",
                     "text": "Si vous avez été amené à recruter du personnel, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "55": {
                     "file": "./gd_animation_organisation_39.csv",
                     "text": "Si vous avez été amené à former du personnel, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "56": {
                     "file": "./gd_animation_organisation_40.csv",
                     "text": "Si vous avez été amené à rémunérer du personnel, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "57": {
                     "file": "./gd_animation_organisation_41.csv",
                     "text": "Si vous avez été amené à mettre fin à votre activité, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "58": {
                     "file": "./gd_animation_organisation_42.csv",
                     "text": "Si vous avez été amené à recruter une personne portant un handicap, pouvez-vous indiquer les éléments de satisfaction et/ou les difficultés rencontrés en précisant, pour chaque point, l'administration concernée"
                 },
                 "59": {
                     "file": "./gd_animation_organisation_43.csv",
                     "text": "Y a-t-il d'autres points sur l'organisation de l'Etat et des services publics sur lesquels vous souhaiteriez vous exprimer ?"
                 },
             }

             for (var qId in questionIdToParams) {
                 d3.select("#question_" + qId)
                   .style("color", inactiveQuestionColor);
             }
             d3.select("#question_" + questionId)
               .style("color", activeQuestionColor);

             loadAndMakeViz(
                 questionIdToParams[questionId]["file"],
                 questionIdToParams[questionId]["text"]
             )
         }

         for (let i = 1; i < 60; i++) {
             let qId = i.toString().padStart(2, "0");
             d3.select("#question_" + qId)
               .on("click", function() {
                   questionClick(qId);
               });
         }
         questionClick("01");

         function loadAndMakeViz(filename, questionText) {
             /* d3.csv('./gd_animation_fiscalite_12.csv', function loadCallback(error, data) { */
             d3.csv(filename, function loadCallback(error, data) {
                 data.forEach(function(d){
                     d.x      = +d.x;
                     d.y      = +d.y;
                     d.init_x = +d.init_x;
                     d.init_y = +d.init_y;
                     d.dim_red_x = +d.dim_red_x;
                     d.dim_red_y = +d.dim_red_y;
                 });
                 makeViz(data, questionText);
             });
         }

         // Global animation variables
         var colorScale        = d3.scale.category10();
         var dotRadius         = 5;
         var dotRadiusAnim     = 7;
         var transitionColor   = "red";
         /* var activeStepColor   = "#5656f9"; */
         var activeStepColor   = "#438aff";
         var inactiveStepColor = "blue";
         // Transition easing - default 'variable' (i.e. has acceleration), also:
         // 'circle', 'elastic', 'bounce', 'linear'
         var transitionEasing  = "variable";
         var animationStart    = 1500;
         var animationEnd      = 1500;
         var animationDelay    = 9000;
         /* var animationStart   = 150;
          * var animationEnd     = 150;
          * var animationDelay   = 900;
          */
         var makeViz = function(dataset, questionText) {
             d3.select("#question")
               .html(questionText);
             // Setup settings for graphic
             var canvasWidth  = 1000;
             var canvasHeight = 600;
             var padding      = 30;  // for chart edges

             // Changing the color of the active step
             d3.selectAll("#step_01, #step_02, #step_03")
               .style(
                   "color", inactiveStepColor
               );

             d3.select("#step_00")
               .style(
                   "color", activeStepColor
               );

             // Create scale functions
             var xScale = d3.scale.linear()  // xScale is width of graphic
                            .domain([
                                d3.min(dataset, function(d) {
                                    return d.init_x;  // input domain
                                }),
                                d3.max(dataset, function(d) {
                                    return d.init_x;  // input domain
                                })
                            ])
                            .range([padding, canvasWidth - padding * 2]); // output range

             var yScale = d3.scale.linear()  // yScale is height of graphic
                            .domain([
                                d3.min(dataset, function(d) {
                                    return d.init_y;  // input domain
                                }),
                                d3.max(dataset, function(d) {
                                    return d.init_y;  // input domain
                                })
                            ])
                            .range([canvasHeight - padding, padding]);  // remember y starts on top going down so we flip

             d3.select("#vis-container")
               .selectAll("*")
               .remove();


             // Create SVG element
             var svg = d3.select("#vis-container")  // This is where we put our vis
                         .append("svg")
                         .attr("width", canvasWidth)
                         .attr("height", canvasHeight);

             // Create tooltip for mouseover
             var tooltip = d3.select("#vis-container")
                             .append("div")
                             .attr("class", "tooltip")
                             .style("opacity", 0.5);

             function tipMouseover(d) {
                 var html = "<b>" + d.comment + "</b>";

                 tooltip.html(html)
                        .style("left", (d3.event.pageX + 15) + "px")
                        .style("top", (d3.event.pageY - 28) + "px")
                        .transition()
                        .duration(200)
                        .style("opacity", .9);
             };

             function tipMouseout(d) {
                 tooltip.transition()
                        .duration(300)
                        .style("opacity", 0);
             };

             // Create Circles
             svg.selectAll("circle")
                .data(dataset)
                .enter()
                .append("circle")
                .attr("class", "dot")
                .attr("cx", function(d) {
                    return xScale(d.init_x);  // Circle's X
                })
                .attr("cy", function(d) {  // Circle's Y
                    return yScale(d.init_y);
                })
                .attr("r", dotRadius)  // radius
                .on("mouseover", tipMouseover)
                .on("mouseout", tipMouseout);

             d3.select("#step_00")
               .on("click", function() {
                   // Changing the color of the active step
                   d3.selectAll("#step_01, #step_02, #step_03")
                     .style(
                         "color", inactiveStepColor
                     );

                   d3.select("#step_00")
                     .style(
                         "color", activeStepColor
                     );

                   // Update scale functions
                   xScale.domain([
                       d3.min(dataset, function(d) {
                           return d.init_x;  // input domain
                       }),
                       d3.max(dataset, function(d) {
                           return d.init_x;  // input domain
                       })
                   ])
                         .range([padding, canvasWidth - padding * 2]); // output range

                   yScale.domain([
                       d3.min(dataset, function(d) {
                           return d.init_y;  // input domain
                       }),
                       d3.max(dataset, function(d) {
                           return d.init_y;  // input domain
                       })
                   ])
                         .range([canvasHeight - padding, padding]);  // remember y starts on top going down so we flip

                   // Update circles
                   svg.selectAll("circle")
                      .data(dataset)  // Update with new data
                      .transition()  // Transition from old to new
                      .duration(animationStart)  // Length of animation
                      .each("start", function() {  // Start animation
                          d3.select(this)  // 'this' means the current element
                            .attr("fill", transitionColor)  // Change color
                            .attr("r", dotRadiusAnim);  // Change size
                      })
                      .delay(function(d, i) {
                          return i / dataset.length * animationDelay;  // Dynamic delay (i.e. each item delays a little longer)
                      })
                      .ease(transitionEasing)
                      .attr("cx", function(d) {
                          return xScale(d.init_x);  // Circle's X
                      })
                      .attr("cy", function(d) {
                          return yScale(d.init_y);  // Circle's Y
                      })
                      .each("end", function() {  // End animation
                          d3.select(this)  // 'this' means the current element
                            .transition()
                            .duration(animationEnd)
                            .attr("fill", "black")
                            .attr("r", dotRadius);  // Change radius
                      });

                   function tipMouseover(d) {
                       var html = "<b>" + d.comment + "</b>";

                       tooltip.html(html)
                              .style("left", (d3.event.pageX + 15) + "px")
                              .style("top", (d3.event.pageY - 28) + "px")
                              .transition()
                              .duration(200)
                              .style("opacity", .9);
                   };

                   function tipMouseout(d) {
                       tooltip.transition()
                              .duration(300)
                              .style("opacity", 0);
                   };

                   d3.selectAll("circle")
                     .on("mouseover", tipMouseover)
                     .on("mouseout", tipMouseout);
               });

             // On click, move each comment to its TSNE position
             d3.select("#step_01")
               .on("click", function() {
                   // Changing the color of the active step
                   d3.selectAll("#step_00, #step_02, #step_03")
                     .style(
                         "color", inactiveStepColor
                     );

                   d3.select("#step_01")
                     .style(
                         "color", activeStepColor
                     );

                   // Update scale domains
                   xScale.domain([
                       d3.min(dataset, function(d) {
                           return d.dim_red_x;
                       }),
                       d3.max(dataset, function(d) {
                           return d.dim_red_x;
                       })]
                   )
                   yScale.domain([
                       d3.min(dataset, function(d) {
                           return d.dim_red_y;
                       }),
                       d3.max(dataset, function(d) {
                           return d.dim_red_y;
                       })
                   ]);

                   // Update circles
                   svg.selectAll("circle")
                      .data(dataset)  // Update with new data
                      .transition()  // Transition from old to new
                      .duration(animationStart)  // Length of animation
                      .each("start", function() {  // Start animation
                          d3.select(this)  // 'this' means the current element
                            .attr("fill", transitionColor)  // Change color
                            .attr("r", dotRadiusAnim);  // Change size
                      })
                      .delay(function(d, i) {
                          return i / dataset.length * animationDelay;  // Dynamic delay (i.e. each item delays a little longer)
                      })
                      .ease(transitionEasing)
                      .attr("cx", function(d) {
                          return xScale(d.dim_red_x);  // Circle's X
                      })
                      .attr("cy", function(d) {
                          return yScale(d.dim_red_y);  // Circle's Y
                      })
                      .each("end", function() {  // End animation
                          d3.select(this)  // 'this' means the current element
                            .transition()
                            .duration(animationEnd)
                            .attr("fill", "black")
                            .attr("r", dotRadius);  // Change radius
                      });

                   function tipMouseover(d) {
                       var html = "<b>" + d.comment + "</b>";

                       tooltip.html(html)
                              .style("left", (d3.event.pageX + 15) + "px")
                              .style("top", (d3.event.pageY - 28) + "px")
                              .transition()
                              .duration(200)
                              .style("opacity", .9);
                   };

                   function tipMouseout(d) {
                       tooltip.transition()
                              .duration(300)
                              .style("opacity", 0);
                   };

                   d3.selectAll("circle")
                     .on("mouseover", tipMouseover)
                     .on("mouseout", tipMouseout);
               });

             // On click, display cluster colors
             d3.select("#step_02")
               .on("click", function() {
                   // Changing the color of the active step
                   d3.selectAll("#step_00, #step_01, #step_03")
                     .style(
                         "color", inactiveStepColor
                     );

                   d3.select("#step_02")
                     .style(
                         "color", activeStepColor
                     );

                   // Update scale domains
                   xScale.domain([
                       d3.min(dataset, function(d) {
                           return d.dim_red_x;
                       }),
                       d3.max(dataset, function(d) {
                           return d.dim_red_x;
                       })]
                   )
                   yScale.domain([
                       d3.min(dataset, function(d) {
                           return d.dim_red_y;
                       }),
                       d3.max(dataset, function(d) {
                           return d.dim_red_y;
                       })
                   ]);

                   // Update circles
                   svg.selectAll("circle")
                      .data(dataset)  // Update with new data
                      .transition()  // Transition from old to new
                      .duration(animationStart)  // Length of animation
                      .each("start", function() {  // Start animation
                          d3.select(this)  // 'this' means the current element
                            .attr("fill", transitionColor)  // Change color
                            .attr("r", dotRadiusAnim);  // Change size
                      })
                      .delay(function(d, i) {
                          return i / dataset.length * animationDelay;  // Dynamic delay (i.e. each item delays a little longer)
                      })
                      .ease(transitionEasing)
                      .attr("cx", function(d) {
                          return xScale(d.dim_red_x);  // Circle's X
                      })
                      .attr("cy", function(d) {
                          return yScale(d.dim_red_y);  // Circle's Y
                      })
                      .each("end", function() {  // End animation
                          d3.select(this)  // 'this' means the current element
                            .transition()
                            .duration(animationEnd)
                            .attr("fill", function(d) {
                                return colorScale(d.cluster_name);
                            })
                            .attr("r", dotRadius);  // Change radius
                      });
                   // .attr("fill", "black")  // Change color

                   function tipMouseover(d) {
                       var color = colorScale(d.cluster_name);
                       var html  = "<b>  <span style='color:" + color + ";'>" + d.comment + "</span> </b>";

                       tooltip.html(html)
                              .style("left", (d3.event.pageX + 15) + "px")
                              .style("top", (d3.event.pageY - 28) + "px")
                              .transition()
                              .duration(200)
                              .style("opacity", .9);
                   };

                   function tipMouseout(d) {
                       tooltip.transition()
                              .duration(300)
                              .style("opacity", 0);
                   };

                   d3.selectAll("circle")
                     .on("mouseover", tipMouseover)
                     .on("mouseout", tipMouseout);
               });

             // On click, Move each comment to their respective clusters
             d3.select("#step_03")
               .on("click", function() {
                   // Changing the color of the active step
                   d3.selectAll("#step_00, #step_01, #step_02")
                     .style(
                         "color", inactiveStepColor
                     );

                   d3.select("#step_03")
                     .style(
                         "color", activeStepColor
                     );

                   // Update scale domains
                   xScale.domain([
                       d3.min(dataset, function(d) {
                           return d.x;
                       }),
                       d3.max(dataset, function(d) {
                           return d.x;
                       })]
                   );
                   yScale.domain([
                       d3.min(dataset, function(d) {
                           return d.y;
                       }),
                       d3.max(dataset, function(d) {
                           return d.y;
                       })
                   ]);

                   // Update circles
                   svg.selectAll("circle")
                      .data(dataset)  // Update with new data
                      .transition()  // Transition from old to new
                      .duration(animationStart)  // Length of animation
                      .each("start", function() {  // Start animation
                          d3.select(this)  // 'this' means the current element
                            .attr("fill", function(d) {
                                return colorScale(d.cluster_name);
                            })
                            .attr("r", dotRadiusAnim);  // Change size
                      })
                      .delay(function(d, i) {
                          return i / dataset.length * animationDelay;  // Dynamic delay (i.e. each item delays a little longer)
                      })
                      .ease(transitionEasing)
                      .attr("cx", function(d) {
                          return xScale(d.x);  // Circle's X
                      })
                      .attr("cy", function(d) {
                          return yScale(d.y);  // Circle's Y
                      })
                      .each("end", function() {  // End animation
                          d3.select(this)  // 'this' means the current element
                            .transition()
                            .duration(animationEnd)
                            .attr("fill", function(d) {
                                return colorScale(d.cluster_name);
                            })
                            .attr("r", dotRadius);  // Change radius
                      });
                   // .attr("fill", "black")  // Change color

                   function tipMouseover(d) {
                       var color = colorScale(d.cluster_name);
                       var html  = "<b> Cluster size: </b>" + d.cluster_size + "(" +(100 * d.cluster_prop).toFixed(2) + "%)<br/>" +
                                   "<b> Cluster title: </b> <span style='color:" + color + ";'>"
                                 + d.cluster_name + "</span><br/>" + "<b>" + d.comment + "</b>";

                       tooltip.html(html)
                              .style("left", (d3.event.pageX + 15) + "px")
                              .style("top", (d3.event.pageY - 28) + "px")
                              .transition()
                              .duration(200)
                              .style("opacity", .9);
                   };

                   function tipMouseout(d) {
                       tooltip.transition()
                              .duration(300)
                              .style("opacity", 0);
                   };

                   d3.selectAll("circle")
                     .on("mouseover", tipMouseover)
                     .on("mouseout", tipMouseout);
               });
         };
        </script>
    </body>
</html>
